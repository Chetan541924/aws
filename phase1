elif action_type == "BUTTON":

    if "name =" not in step_name:
        raise RuntimeError("BUTTON step missing button name")

    step_lower = step_name.lower()
    button_name = step_name.split("name =")[-1].strip().lower()

    # Always resolve frames fresh
    nav_frame, content_frame = resolve_ccs_frames(page)

    # Wait for page to be ready
    await content_frame.wait_for_load_state("domcontentloaded", timeout=15000)
    await page.wait_for_timeout(1000)

    # ------------------------------
    # Resolve section explicitly
    # ------------------------------
    section = None
    if " in the " in step_lower:
        section = (
            step_lower.split(" in the ", 1)[1]
            .split(" with name", 1)[0]
            .replace(" section", "")
            .strip()
        )

    logger.info(
        LogCategory.EXECUTION,
        f"[PHASE 3] Looking for button '{button_name}' in section '{section}'"
    )

    # ------------------------------
    # SPECIAL HANDLING FOR "EDIT" BUTTONS
    # ------------------------------
    if button_name == "edit" and section:
        logger.info(
            LogCategory.EXECUTION,
            f"[PHASE 3] ‚ö†Ô∏è EDIT BUTTON SPECIAL HANDLING ACTIVATED for section: '{section}'"
        )
        
        # Find the correct Edit button and get its unique onclick attribute
        button_info = await content_frame.evaluate(
            """
            (sectionName) => {
                const editButtons = Array.from(document.querySelectorAll('input[type="button"][value="Edit"]'));
                
                console.log('=== EDIT BUTTON SEARCH ===');
                console.log('Total Edit buttons found:', editButtons.length);
                console.log('Looking for section:', sectionName);
                
                // Log all Edit buttons with their context
                editButtons.forEach((btn, idx) => {
                    const onclick = btn.getAttribute('onclick') || 'no-onclick';
                    let parent = btn.parentElement;
                    let context = '';
                    let depth = 0;
                    
                    while (parent && depth < 5) {
                        const text = parent.textContent?.substring(0, 100) || '';
                        if (text.length > context.length) {
                            context = text;
                        }
                        parent = parent.parentElement;
                        depth++;
                    }
                    
                    console.log(`Button ${idx}: onclick="${onclick.substring(0, 50)}...", context="${context.substring(0, 80)}..."`);
                });
                
                // Now find the matching button
                for (let i = 0; i < editButtons.length; i++) {
                    const btn = editButtons[i];
                    let parent = btn.parentElement;
                    let depth = 0;
                    
                    while (parent && depth < 10) {
                        const parentText = parent.textContent || '';
                        
                        if (parentText.toLowerCase().includes(sectionName.toLowerCase())) {
                            if (parentText.length < 2000) {
                                console.log('‚úÖ MATCH FOUND at index', i);
                                
                                return {
                                    found: true,
                                    index: i,
                                    onclick: btn.getAttribute('onclick'),
                                    buttonId: btn.id || 'no-id',
                                    matchedText: parentText.substring(0, 100)
                                };
                            }
                        }
                        
                        parent = parent.parentElement;
                        depth++;
                    }
                }
                
                console.log('‚ùå NO MATCH FOUND');
                return {found: false, totalButtons: editButtons.length};
            }
            """,
            section
        )
        
        logger.info(
            LogCategory.EXECUTION,
            f"[DEBUG] Button search result: {button_info}"
        )
        
        if button_info.get('found'):
            onclick_value = button_info.get('onclick')
            
            if not onclick_value or onclick_value == 'None':
                raise RuntimeError(f"Edit button found but has no onclick attribute")
            
            logger.info(
                LogCategory.EXECUTION,
                f"[DEBUG] Target button onclick: {onclick_value[:80]}..."
            )
            
            # Now click using the unique onclick attribute as selector
            click_success = await content_frame.evaluate(
                """
                (onclickValue) => {
                    const allEditButtons = document.querySelectorAll('input[type="button"][value="Edit"]');
                    
                    for (let btn of allEditButtons) {
                        const btnOnclick = btn.getAttribute('onclick');
                        
                        if (btnOnclick === onclickValue) {
                            console.log('üéØ Found exact button match by onclick attribute');
                            btn.scrollIntoView({behavior: 'instant', block: 'center'});
                            
                            // Force focus and click
                            btn.focus();
                            btn.click();
                            
                            console.log('‚úÖ Button clicked');
                            return true;
                        }
                    }
                    
                    console.log('‚ùå Could not find button with matching onclick');
                    return false;
                }
                """,
                onclick_value
            )
            
            if not click_success:
                raise RuntimeError(f"Could not click Edit button with onclick: {onclick_value[:50]}")
            
            logger.info(
                LogCategory.EXECUTION,
                f"[PHASE 3] ‚úÖ Edit button clicked successfully in section: {section}"
            )
            
            # Wait for JSF to process
            await page.wait_for_timeout(2000)
            
            try:
                await page.wait_for_load_state("networkidle", timeout=10000)
            except:
                logger.warning(LogCategory.EXECUTION, "Network didn't stabilize")
            
            await page.wait_for_timeout(2000)
            
        else:
            total = button_info.get('totalButtons', 0)
            raise RuntimeError(
                f"Could not find Edit button in section '{section}'. "
                f"Total buttons: {total}. Check logs for button details."
            )
    
    else:
        # ------------------------------
        # NORMAL BUTTON HANDLING
        # ------------------------------
        if section:
            section_root = content_frame.locator(
                f"div:has-text('{section.title()}')"
            ).first
            
            try:
                await section_root.wait_for(state="visible", timeout=10000)
            except:
                logger.warning(
                    LogCategory.EXECUTION,
                    f"Section '{section}' not immediately visible, searching entire frame"
                )
                section_root = content_frame
            
            buttons = section_root.locator(
                "input[type='button'], input[type='submit'], button"
            )
        else:
            buttons = content_frame.locator(
                "input[type='button'], input[type='submit'], button"
            )

        clicked = False
        count = await buttons.count()
        
        logger.info(
            LogCategory.EXECUTION,
            f"[PHASE 3] Found {count} buttons in {'section: ' + section if section else 'frame'}"
        )
        
        if count == 0:
            raise RuntimeError(
                f"No buttons found in {'section: ' + section if section else 'frame'}"
            )

        for i in range(count):
            btn = buttons.nth(i)
            
            value = (await btn.get_attribute("value") or "").lower()
            text = (await btn.text_content() or "").lower()
            id_ = (await btn.get_attribute("id") or "").lower()
            
            logger.info(
                LogCategory.EXECUTION,
                f"[DEBUG] Button {i+1}: value='{value}', text='{text}', id='{id_}'"
            )

            if button_name in (value + text + id_):
                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] Found matching button: {button_name}"
                )
                
                await btn.scroll_into_view_if_needed()
                await page.wait_for_timeout(500)
                await btn.wait_for(state="visible", timeout=10000)
                await btn.hover()
                await content_frame.wait_for_timeout(200)
                await btn.click(force=True)
                
                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] BUTTON clicked: {button_name}"
                )
                
                await page.wait_for_timeout(3000)
                
                try:
                    await content_frame.wait_for_load_state("networkidle", timeout=10000)
                except:
                    logger.warning(
                        LogCategory.EXECUTION,
                        "Network didn't reach idle state, continuing anyway"
                    )
                
                await page.wait_for_timeout(1000)
                
                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] BUTTON click successful: {button_name} in {section}"
                )
                
                clicked = True
                break

        if not clicked:
            raise RuntimeError(
                f"Button '{button_name}' not found in {'section: ' + section if section else 'frame'}"
            )
