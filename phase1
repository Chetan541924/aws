elif action_type == "BUTTON":

    if "name =" not in step_name:
        raise RuntimeError("BUTTON step missing button name")

    step_lower = step_name.lower()
    button_name = step_name.split("name =")[-1].strip().lower()

    # Always resolve frames fresh
    nav_frame, content_frame = resolve_ccs_frames(page)

    # Wait for page to be ready
    await content_frame.wait_for_load_state("domcontentloaded", timeout=15000)
    await page.wait_for_timeout(1000)

    # ------------------------------
    # Resolve section explicitly
    # ------------------------------
    section = None
    if " in the " in step_lower:
        section = (
            step_lower.split(" in the ", 1)[1]
            .split(" with name", 1)[0]
            .replace(" section", "")
            .strip()
        )

    logger.info(
        LogCategory.EXECUTION,
        f"[PHASE 3] Looking for button '{button_name}' in section '{section}'"
    )

    # ------------------------------
    # SPECIAL HANDLING FOR "EDIT" BUTTONS
    # ------------------------------
    if button_name == "edit" and section:
        logger.info(
            LogCategory.EXECUTION,
            f"[PHASE 3] Special Edit button handling for section: {section}"
        )
        
        # Strategy: Find the section by its heading text, then find Edit button within it
        # Look for div/fieldset that contains the section name
        
        # Try multiple section container strategies
        section_container = None
        
        # Strategy 1: Look for exact section text in a div
        try:
            section_container = content_frame.locator(
                f"div:has-text('{section}'):has(input[value='Edit'])"
            ).first
            await section_container.wait_for(state="visible", timeout=5000)
            logger.info(LogCategory.EXECUTION, "[DEBUG] Found section using strategy 1")
        except:
            pass
        
        # Strategy 2: Look for fieldset or panel with legend containing section name
        if not section_container:
            try:
                section_container = content_frame.locator(
                    f"fieldset:has(legend:has-text('{section}'))"
                ).first
                await section_container.wait_for(state="visible", timeout=5000)
                logger.info(LogCategory.EXECUTION, "[DEBUG] Found section using strategy 2")
            except:
                pass
        
        # Strategy 3: Find any container with the section text and an Edit button
        if not section_container:
            try:
                # More flexible - find any div/section/fieldset containing both the text and Edit button
                containers = content_frame.locator("div, section, fieldset")
                count = await containers.count()
                
                for i in range(count):
                    container = containers.nth(i)
                    text_content = await container.text_content()
                    
                    if text_content and section.lower() in text_content.lower():
                        # Check if this container has an Edit button
                        edit_in_container = container.locator("input[value='Edit'], button:has-text('Edit')")
                        if await edit_in_container.count() > 0:
                            section_container = container
                            logger.info(LogCategory.EXECUTION, f"[DEBUG] Found section using strategy 3 at index {i}")
                            break
            except:
                pass
        
        if section_container:
            # Found the section, now click Edit button within it
            edit_button = section_container.locator("input[value='Edit'], button:has-text('Edit')").first
            
            try:
                await edit_button.scroll_into_view_if_needed()
                await page.wait_for_timeout(500)
                await edit_button.wait_for(state="visible", timeout=10000)
                await edit_button.click(force=True)
                
                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] Edit button clicked in section: {section}"
                )
                
                await page.wait_for_timeout(3000)
                
                try:
                    await content_frame.wait_for_load_state("networkidle", timeout=10000)
                except:
                    logger.warning(LogCategory.EXECUTION, "Network didn't reach idle state")
                
                await page.wait_for_timeout(1000)
                
                # Success - continue to next step
                # (No 'continue' statement here - let it fall through naturally)
                
            except Exception as e:
                raise RuntimeError(f"Failed to click Edit button in section '{section}': {str(e)}")
        else:
            raise RuntimeError(f"Could not locate section '{section}' with Edit button")
    
    else:
        # ------------------------------
        # NORMAL BUTTON HANDLING (non-Edit or no section)
        # ------------------------------
        if section:
            section_root = content_frame.locator(
                f"div:has-text('{section.title()}')"
            ).first
            
            try:
                await section_root.wait_for(state="visible", timeout=10000)
            except:
                logger.warning(
                    LogCategory.EXECUTION,
                    f"Section '{section}' not immediately visible, searching entire frame"
                )
                section_root = content_frame
            
            buttons = section_root.locator(
                "input[type='button'], input[type='submit'], button"
            )
        else:
            buttons = content_frame.locator(
                "input[type='button'], input[type='submit'], button"
            )

        clicked = False
        count = await buttons.count()
        
        logger.info(
            LogCategory.EXECUTION,
            f"[PHASE 3] Found {count} buttons in {'section: ' + section if section else 'frame'}"
        )
        
        if count == 0:
            raise RuntimeError(
                f"No buttons found in {'section: ' + section if section else 'frame'}"
            )

        for i in range(count):
            btn = buttons.nth(i)
            
            value = (await btn.get_attribute("value") or "").lower()
            text = (await btn.text_content() or "").lower()
            id_ = (await btn.get_attribute("id") or "").lower()
            
            logger.info(
                LogCategory.EXECUTION,
                f"[DEBUG] Button {i+1}: value='{value}', text='{text}', id='{id_}'"
            )

            if button_name in (value + text + id_):
                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] Found matching button: {button_name}"
                )
                
                await btn.scroll_into_view_if_needed()
                await page.wait_for_timeout(500)
                await btn.wait_for(state="visible", timeout=10000)
                await btn.hover()
                await content_frame.wait_for_timeout(200)
                await btn.click(force=True)
                
                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] BUTTON clicked: {button_name}"
                )
                
                await page.wait_for_timeout(3000)
                
                try:
                    await content_frame.wait_for_load_state("networkidle", timeout=10000)
                except:
                    logger.warning(
                        LogCategory.EXECUTION,
                        "Network didn't reach idle state, continuing anyway"
                    )
                
                await page.wait_for_timeout(1000)
                
                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] BUTTON click successful: {button_name} in {section}"
                )
                
                clicked = True
                break

        if not clicked:
            raise RuntimeError(
                f"Button '{button_name}' not found in {'section: ' + section if section else 'frame'}"
            )
```

## How to Use It

Update your test steps to include the section name:
```
When the user clicks the button in the ERBE Claim section with name = Edit
When the user clicks the button in the Specialist Only section with name = Edit
When the user clicks the button in the Does this claim require back dating section with name = Edit
```

Or using the visible section headers:
```
Step X: When the user clicks the button in the ERBE Claim with name = Edit
