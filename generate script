def get_execution_logs(testcase_id: str) -> list[dict]:
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cur = conn.cursor()

    cur.execute("""
        SELECT
            step_order,
            gherkin_step,
            action_type,
            locator_strategy,
            locator_value,
            input_value,
            frame_url,
            confidence
        FROM execution_steps
        WHERE testcase_id = ?
        ORDER BY step_order
    """, (testcase_id,))

    rows = cur.fetchall()
    conn.close()

    return [dict(row) for row in rows]



execution_logs = get_execution_logs(testcase_id)

if not execution_logs:
    raise HTTPException(400, "No execution logs found for this test case")



prompt = f"""
You are an expert {script_type} automation engineer.

TEST CASE ID: {testcase_id}
FRAMEWORK: {script_type}
LANGUAGE: {script_lang}

{prereq_text}

TEST PLAN (INTENT):
{json.dumps(normalized_testplan, indent=2, ensure_ascii=False)}

EXECUTION LOGS (ACTUAL EXECUTION DATA):
{json.dumps(execution_logs, indent=2, ensure_ascii=False)}

CRITICAL INSTRUCTIONS (READ CAREFULLY):

- Generate a SINGLE, LINEAR, EXECUTABLE automation script
- DO NOT create helper classes
- DO NOT create reusable methods
- DO NOT refactor or merge steps
- DO NOT invent selectors
- DO NOT change locator strategies
- DO NOT skip steps
- Execute steps STRICTLY in the order of execution logs
- Each execution log entry MUST map to exactly ONE automation command
- Use frame navigation exactly as recorded
- Use waits explicitly where needed
- Preserve input values exactly
- The output must be runnable top-to-bottom

OUTPUT RULES:
- Return ONLY the final executable script
- NO markdown
- NO JSON
- NO explanations
- NO comments outside the code
"""



raw_output = response.choices[0].message.content.strip()

if not raw_output:
    raise HTTPException(500, "Generated script is empty")

generated_script = raw_output.replace("\\n", "\n").strip()




class GeneratedScriptResponse(BaseModel):
    testcase_id: str
    script_type: str
    script_lang: str
    generated_script: str
    model_used: str


return GeneratedScriptResponse(
    testcase_id=testcase_id,
    script_type=script_type,
    script_lang=script_lang,
    generated_script=generated_script,
    model_used=response.model
)



