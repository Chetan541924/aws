step_lower = step_name.lower()

if "click on the link" in step_lower:
    action_type = "NAV_CLICK"
elif "clicks the button" in step_lower:
    action_type = "BUTTON_CLICK"
elif "enters" in step_lower:
    action_type = "INPUT"
elif "selects" in step_lower:
    action_type = "SELECT"
else:
    raise RuntimeError("Unsupported ACTION step")


elif action_type == "BUTTON_CLICK":
    button_name = step_name.split("=")[-1].strip()
    button = content_frame.get_by_role("button", name=button_name, exact=True)
    await button.wait_for(state="visible", timeout=20000)
    await button.click()


elif action_type == "INPUT":
    value = step_name.split("'")[1]
    field_name = step_name.split("'")[-2]

    input_box = content_frame.get_by_label(field_name)
    await input_box.wait_for(state="visible", timeout=20000)
    await input_box.fill(value)


elif action_type == "SELECT":
    if "'" not in step_name:
        raise RuntimeError("SELECT step missing quoted option")

    option_text = step_name.split("'")[1].strip()

    select_elements = content_frame.locator("select")
    select_count = await select_elements.count()

    if select_count == 0:
        raise RuntimeError("No <select> elements found on page")

    for i in range(select_count):
        select = select_elements.nth(i)

        try:
            # Verify option exists in this select before selecting
            option = select.locator("option", has_text=option_text)
            if await option.count() == 0:
                continue

            await select.select_option(label=option_text)

            logger.info(
                LogCategory.EXECUTION,
                f"[PHASE 3] SELECT successful: {option_text}"
            )

            return

        except Exception:
            continue

    raise RuntimeError(
        f"Option '{option_text}' not found in any <select> element"
    )


