step_lower = step_name.lower()

if "click on the link" in step_lower:
    action_type = "NAV_CLICK"
elif "clicks the button" in step_lower:
    action_type = "BUTTON_CLICK"
elif "enters" in step_lower:
    action_type = "INPUT"
elif "selects" in step_lower:
    action_type = "SELECT"
else:
    raise RuntimeError("Unsupported ACTION step")


elif action_type == "BUTTON_CLICK":
    button_name = step_name.split("=")[-1].strip()
    button = content_frame.get_by_role("button", name=button_name, exact=True)
    await button.wait_for(state="visible", timeout=20000)
    await button.click()


elif action_type == "INPUT":
    if "'" not in step_name:
        raise RuntimeError("INPUT step missing quoted value")

    value = step_name.split("'")[1].strip()

    # Resolve frames at ACTION time (CRITICAL)
    nav_frame, content_frame = resolve_ccs_frames(page)

    # 1. Find all visible text inputs
    inputs = content_frame.locator("input[type='text']:visible")
    count = await inputs.count()

    if count == 0:
        raise RuntimeError("No visible text input fields found")

    # 2. Prefer inputs related to account / numeric search
    preferred_keywords = [
        "account",
        "number",
        "numeric",
        "search"
    ]

    for i in range(count):
        inp = inputs.nth(i)

        id_attr = (await inp.get_attribute("id") or "").lower()
        name_attr = (await inp.get_attribute("name") or "").lower()

        if any(k in id_attr for k in preferred_keywords) or \
           any(k in name_attr for k in preferred_keywords):

            await inp.fill(value)

            logger.info(
                LogCategory.EXECUTION,
                f"[PHASE 3] INPUT successful (semantic match): {value}"
            )
            return

    # 3. Fallback: fill the first visible input
    await inputs.first.fill(value)

    logger.info(
        LogCategory.EXECUTION,
        f"[PHASE 3] INPUT successful (fallback): {value}"
    )
    return




elif action_type == "SELECT":
    if "'" not in step_name:
        raise RuntimeError("SELECT step missing quoted option")

    option_text = step_name.split("'")[1].strip()

    # ðŸ”´ ALWAYS re-resolve frames before interacting
    nav_frame, content_frame = resolve_ccs_frames(page)

    select_elements = content_frame.locator("select")
    select_count = await select_elements.count()

    if select_count == 0:
        raise RuntimeError("No <select> elements found on page")

    for i in range(select_count):
        select = select_elements.nth(i)

        try:
            option = select.locator("option", has_text=option_text)
            if await option.count() == 0:
                continue

            await select.wait_for(state="visible", timeout=20000)
            await select.select_option(label=option_text)

            logger.info(
                LogCategory.EXECUTION,
                f"[PHASE 3] SELECT successful: {option_text}"
            )
            return

        except Exception:
            continue

    raise RuntimeError(
        f"Option '{option_text}' not found in any <select> element"
    )






async def refresh_content_frame(page):
    for _ in range(10):
        for frame in page.frames:
            if "ccs.do" in frame.url:
                return frame
        await asyncio.sleep(0.5)
    raise RuntimeError("Unable to resolve CCS content frame after navigation")


elif action_type == "SELECT":
    content_frame = await refresh_content_frame(page)



await click_nav_link(nav_frame, target)

# â¬‡â¬‡â¬‡ REQUIRED
await page.wait_for_load_state("networkidle")
content_frame = await refresh_content_frame(page)




def resolve_ccs_frames(page):
    nav_frame = None
    content_frame = None

    for frame in page.frames:
        url = frame.url or ""

        # Navigation frame: contains top tabs (Customer, Claims, etc.)
        if "currentNavPosition" in url or "nav" in url:
            nav_frame = frame

        # Content frame: CCS business pages
        elif "ccs/" in url and not "currentNavPosition" in url:
            content_frame = frame

    if not content_frame:
        raise RuntimeError("CCS content frame not found")

    # nav_frame may temporarily disappear during transitions
    return nav_frame, content_frame


