When the user clicks on the link with the name = MITCHELLS OFFICES & STORAGE LLC

Then the Text 'Customer Display' is visible

Then the Text 'MITCHELLS OFFICES & STORAGE LLC' is visible

When the user selects 'Create a New Claim' from the dropdown with name = Select An Action

When the user clicks the button with name = Go

Then the Text 'Create a Claim' is visible

Then the Text 'Reference Number: New Claim' is visible


elif action_type == "SELECT":

    if "selects" not in step_name:
        raise RuntimeError("SELECT step format invalid")

    option_text = (
        step_name
        .split("selects", 1)[-1]
        .split("from", 1)[0]
        .strip()
        .strip("'\"")
        .lower()
    )

    nav_frame, content_frame = resolve_ccs_frames(page)

    await page.wait_for_load_state("networkidle")

    # ==========================================================
    # CASE 1: CCS "Select An Action" dropdown (Create New Claim)
    # ==========================================================
    if "create a new claim" in option_text:
        await content_frame.wait_for_timeout(2000)

        async def try_action_select(frame):
            sel = frame.locator("select[name='selectAndGo']")
            if await sel.count() == 0:
                return False

            await sel.scroll_into_view_if_needed()
            await sel.wait_for(state="visible", timeout=10000)

            options = sel.locator("option")
            count = await options.count()

            for i in range(count):
                opt = options.nth(i)
                text = (await opt.text_content() or "").lower()
                value = (await opt.get_attribute("value") or "").lower()

                if option_text in text or option_text in value:
                    await sel.select_option(value=await opt.get_attribute("value"))
                    return True

            return False

        if not await try_action_select(content_frame):
            if not await try_action_select(nav_frame):
                raise RuntimeError(
                    f"Option '{option_text}' not found in Select An Action dropdown"
                )

        logger.info(
            LogCategory.EXECUTION,
            f"[PHASE 3] SELECT successful: {option_text}"
        )
        return

    # ==========================================================
    # CASE 2: Generic SELECT (Account Number, etc.)
    # ==========================================================
    await content_frame.wait_for_selector("select", timeout=15000)

    selects = content_frame.locator("select")
    count = await selects.count()

    for i in range(count):
        sel = selects.nth(i)
        await sel.scroll_into_view_if_needed()
        await sel.wait_for(state="visible", timeout=10000)

        options = sel.locator("option")
        opt_count = await options.count()

        for j in range(opt_count):
            opt = options.nth(j)
            text = (await opt.text_content() or "").lower()
            value = (await opt.get_attribute("value") or "").lower()

            if option_text in text or option_text in value:
                await sel.select_option(value=await opt.get_attribute("value"))

                logger.info(
                    LogCategory.EXECUTION,
                    f"[PHASE 3] SELECT successful: {option_text}"
                )
                return

    raise RuntimeError(f"Option '{option_text}' not found in any <select>")




elif action_type == "ACCOUNT_ROW_CLICK":

    nav_frame, content_frame = resolve_ccs_frames(page)
    await page.wait_for_load_state("networkidle")

    # Find account number spans (hover-based CCS links)
    account_spans = content_frame.locator("span[onmouseover][onmouseout]")

    count = await account_spans.count()
    if count == 0:
        raise RuntimeError("No account numbers found in Customer Account List")

    step_lower = step_name.lower()

    # CASE 1: first account
    if "first" in step_lower:
        span = account_spans.nth(0)

    # CASE 2: last account
    elif "last" in step_lower:
        span = account_spans.nth(count - 1)

    else:
        raise RuntimeError("Account row click requires 'first' or 'last'")

    # Hover to ensure visibility (safe, not required but good)
    await span.scroll_into_view_if_needed()
    await span.hover()
    await content_frame.wait_for_timeout(300)
    
    box = await span.bounding_box()
    if not box:
        raise RuntimeError("Account number not interactable")
    
    await page.mouse.click(
        box["x"] + box["width"] / 2,
        box["y"] + box["height"] / 2
    )


    logger.info(
        LogCategory.EXECUTION,
        "[PHASE 3] ACCOUNT ROW CLICK successful"
    )
